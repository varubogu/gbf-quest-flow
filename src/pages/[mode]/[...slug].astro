---
import FlowBaseLayout from '@/layouts/FlowBaseLayout.astro';
import FlowBodyLayout from '@/layouts/FlowBodyLayout';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const flows = await getCollection('flows');

  // viewとeditの両方のパスを生成
  const paths = flows.flatMap(flow => [
    {
      params: { mode: 'view', slug: flow.id },
      props: { flowData: flow.data }
    },
    {
      params: { mode: 'edit', slug: flow.id },
      props: { flowData: flow.data }
    }
  ]);

  return paths;
}

const { mode, slug } = Astro.params;
const { flowData } = Astro.props;

// モードの検証
if (!['view', 'edit'].includes(mode || '')) {
  return Astro.redirect('/404');
}

// slugがない場合は404へ
if (!slug) {
  return Astro.redirect('/404');
}

// データが見つからない場合は404へ
if (!flowData) {
  return Astro.redirect('/404');
}
---

<FlowBaseLayout>
  <FlowBodyLayout
    client:load
    initialData={flowData}
    initialMode={mode as 'view' | 'edit'}
    sourceId={slug}
  />
</FlowBaseLayout>